{% extends "admin/base.html" %}

{% block content %}
<div class="container mt-3">
    <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
        <!-- Add New button -->
        <a class="btn btn-success" href="#" id="addNewBtn">+ Add New</a>

        <!-- Section Dropdown -->
        <div class="col-md-2" id="section">
           <select id="sectionSelect" name="section[]" class="form-control" multiple>
               {% for sec in sections %}
                   <option value="{{ sec }}"
                       {% if selected_sections and sec in selected_sections %} selected {% endif %}>
                       {{ sec }}
                   </option>
               {% endfor %}
           </select>
        </div>

        <button type="button" id="searchBtn" class="btn btn-primary">Search</button>
    </div>

    <table id="articleTable" class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Category</th>
                <th>Section</th>
                <th>Title</th>
                <th>Assessment Year</th>
                <th>Detail</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
    </table>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalTitle">Article Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detailModalBody" style="overflow-x:auto;"></div>
      <div class="modal-footer">
        <!--<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>-->
      </div>
    </div>
  </div>
</div>

<!-- Form Modal (Add/Edit) -->
<div class="modal fade" id="formModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="formModalTitle">Form</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="formModalBody" style="overflow-x:auto;"></div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='ckeditor/ckeditor.js') }}"></script>
<script>
$(document).ready(function(){

    // Initialize Choices.js for multi-select
    const sectionChoice = new Choices('#sectionSelect', {
        removeItemButton: true,
        searchEnabled: true,
        placeholderValue: '-- Select Section --'
    });

    // Initialize DataTable
    var table = $('#articleTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "{{ url_for('admin_document.fetch_articles') }}",
            type: 'GET',
            data: function(d) {
                var selectedSections = $('#sectionSelect').val() || [];
                d['section[]'] = selectedSections;
            }
        },
        columns: [
            { data: 'id' },
            { data: 'category' },
            { data: 'section' },
            { data: 'title' },
            { data: 'assessment_year' },
            { data: 'id' },  // Detail
            { data: 'id' },  // Edit
            { data: 'id' }   // Delete
        ],
        columnDefs: [
            {
                targets: 5,
                render: data => `<button class="btn btn-primary btn-sm viewBtn" data-id="${data}">
                                    <i class="fas fa-eye"></i>
                                 </button>`
            },
            {
                targets: 6,
                render: data => `<button class="btn btn-warning btn-sm editBtn" data-id="${data}">
                                    <i class="fas fa-edit"></i>
                                 </button>`
            },
            {
                targets: 7,
                render: data => `<button class="btn btn-link text-danger p-0 m-0 deleteBtn" data-id="${data}">
                                    <i class="fas fa-trash"></i>
                                 </button>`
            }
        ],
        pageLength: 20
    });

    // Reload table on section change or search
    $('#sectionSelect, #searchBtn').on('change click', function(){
        table.ajax.reload();
    });

    // View Detail
    $(document).on('click', '.viewBtn', function(){
        $.get(`/admin/document/detail-article/${$(this).data('id')}`, function(data){
            $('#detailModalBody').html(data);
            new bootstrap.Modal('#detailModal').show();
        });
    });

    // Add New Article
    $('#addNewBtn').on('click', function(e){
        e.preventDefault();
        $.get("{{ url_for('admin_document.add_article') }}", function(data){
            $('#formModalTitle').text('Add New Article');
            $('#formModalBody').html(data);
            CKEDITOR.replace('ckeditor');
            new bootstrap.Modal('#formModal').show();
        });
    });

    // Edit Article
    $(document).on('click', '.editBtn', function(){
        $.get(`/admin/document/edit/${$(this).data('id')}`, function(data){
            $('#formModalTitle').text('Edit Article');
            $('#formModalBody').html(data);
            CKEDITOR.replace('ckeditor');
            new bootstrap.Modal('#formModal').show();
        });
    });

    // Submit Form (Add/Edit)
    $(document).on('submit', '#articleForm', function(e){
        e.preventDefault();
        $.post($(this).attr('action'), $(this).serialize(), function(res){
            if(res.status === 'success'){
                table.ajax.reload();
                Swal.fire({
                    icon: 'success',
                    title: res.message,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });
                bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: res.message
                });
            }
        });
    });

    // Delete Article with SweetAlert
    $(document).on('click', '.deleteBtn', function(e){
        e.preventDefault();
        let articleId = $(this).data('id');
        let deleteUrl = `/admin/document/delete/${articleId}`;

        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if(result.isConfirmed){
                $.ajax({
                    url: deleteUrl,
                    type: 'POST',
                    success: function(res){
                        if(res.status === 'success'){
                            Swal.fire({
                                icon: 'success',
                                title: res.message,
                                timer: 1500,
                                showConfirmButton: false
                            });
                            table.ajax.reload();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: res.message
                            });
                        }
                    },
                    error: function(xhr, status, error){
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error
                        });
                    }
                });
            }
        });
    });

});
</script>

<style>
.modal-body { overflow-x:auto; }
.modal-header, .modal-footer { width: 100%; }
</style>
{% endblock %}
