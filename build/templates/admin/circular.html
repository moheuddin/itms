{% extends "admin/base.html" %}

{% block content %}
<div class="container mt-5">

    <button class="btn btn-success mb-3" id="addNewBtn">Add New Circular</button>

    <table id="circularTable" class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Category</th>
                <th>Number</th>
                <th>Date</th>
                <th>Year</th>
                <th>Subject</th>
                <th>Files</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for row in uploads %}
            <tr id="row-{{ row.id }}">
                <td>{{ row.id }}</td>
                <td>{{ row.category }}</td>
                <td>{{ row.number }}</td>
                <td>{{ row.date }}</td>
                <td>{{ row.year }}</td>
                <td>{{ row.subject }}</td>
                <td>
                    {% for f in row.files %}
                    <div id="file-{{ row.id }}-{{ loop.index }}">
                        <a href="{{ url_for('static', filename='uploads/' ~ f) }}" target="_blank">{{ f }}</a>
                        <button class="btn btn-sm btn-outline-danger ms-1 deleteFileBtn" data-id="{{ row.id }}" data-file="{{ f }}">[Delete]</button>
                    </div>
                    {% endfor %}
                </td>
                <td>
                    <button class="btn btn-sm btn-info editBtn"
                            data-id="{{ row.id }}"
                            data-category="{{ row.category }}"
                            data-number="{{ row.number }}"
                            data-year="{{ row.year }}"
                            data-date="{{ row.date }}"
                            data-subject="{{ row.subject }}"
                            data-files='{{ row.files | tojson | safe }}'>
                        <i class="fa fa-edit"></i>
                    </button>

                    <button class="btn btn-sm btn-danger deleteBtn" data-id="{{ row.id }}">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<!-- Modal -->
<div class="modal fade" id="circularModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="circularForm" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Circular</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="circularId">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="circularCategory">Category</label>
                            <select name="category" id="circularCategory" class="form-select" required>
                                <option value="">--Select Category--</option>
                                {% for cat in categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="circularNumber">Number</label>
                            <input type="text" name="number" id="circularNumber" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="circularYear">Year</label>
                            <input type="text" name="year" id="circularYear" class="form-control" maxlength="4" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="circularDate">Date</label>
                            <input type="date" name="date" id="circularDate" class="form-control" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="circularSubject">Subject</label>
                            <input type="text" name="subject" id="circularSubject" class="form-control" required>
                        </div>
                    </div>

                    <div id="existingFiles" class="mb-3"></div>

                    <div class="mb-3" id="fileInputs">
                        <label for="fileInput">Files</label>
                        <div class="input-group mb-2">
                            <input type="file" name="files[]" class="form-control">
                            <button type="button" class="btn btn-outline-secondary addFileBtn">+</button>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" id="modalSubmit">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

    const modal = new bootstrap.Modal(document.getElementById('circularModal'));

    // Add new
    document.getElementById('addNewBtn').addEventListener('click', ()=>{

    document.getElementById('modalTitle').textContent = 'Add Circular';
    document.getElementById('circularId').value = '';
    document.getElementById('circularCategory').value = '';
    document.getElementById('circularNumber').value = '';
    document.getElementById('circularYear').value = '';
    document.getElementById('circularDate').value = '';
    document.getElementById('circularSubject').value = '';

    // Clear existing files section
    document.getElementById('existingFiles').innerHTML = '';

    // Reset file upload section completely
    const fileInputs = document.getElementById("fileInputs");
    fileInputs.innerHTML = `
        <label for="fileInput">Files</label>
        <div class="input-group mb-2">
            <input type="file" name="files[]" class="form-control">
            <button type="button" class="btn btn-outline-secondary addFileBtn">+</button>
        </div>
    `;

    modal.show();
});


    // Edit
    document.querySelectorAll('.editBtn').forEach(btn=>{
        btn.addEventListener('click', function(){
            document.getElementById('modalTitle').textContent = 'Edit Circular';
            document.getElementById('circularId').value = this.dataset.id;
            document.getElementById('circularCategory').value = this.dataset.category;
            document.getElementById('circularNumber').value = this.dataset.number;
            document.getElementById('circularYear').value = this.dataset.year;
            document.getElementById('circularDate').value = this.dataset.date.split(' ')[0];
            document.getElementById('circularSubject').value = this.dataset.subject;

            const existingDiv = document.getElementById('existingFiles');
            existingDiv.innerHTML = '';
            let files = [];
            try { files = JSON.parse(this.dataset.files || '[]'); } catch(e){}

            files.forEach((f,i)=>{
                const div = document.createElement('div');
                div.id = `file-${this.dataset.id}-${i}`;
                div.innerHTML = `<a href="/static/uploads/${f}" target="_blank">${f}</a>
                                 <button class="btn btn-sm btn-outline-danger ms-1 deleteFileBtn" data-id="${this.dataset.id}" data-file="${f}">[Delete]</button>`;
                existingDiv.appendChild(div);
            });

            modal.show();
        });
    });

    // Add more file inputs
    document.addEventListener('click', function(e){
        if(e.target.classList.contains('addFileBtn')){
            const parent = e.target.closest('#fileInputs');
            const div = document.createElement('div');
            div.classList.add('input-group','mb-2');
            div.innerHTML = `<input type="file" name="files[]" class="form-control">
                             <button type="button" class="btn btn-outline-danger removeFileBtn">-</button>`;
            parent.appendChild(div);
        }
        if(e.target.classList.contains('removeFileBtn')){
            e.target.closest('.input-group').remove();
        }
    });

    // Submit Add/Edit via AJAX
    document.getElementById('circularForm').addEventListener('submit', function(e){
        e.preventDefault();
        const formData = new FormData(this);

        $.ajax({
            url: '/admin/circular/save',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(res){
                Swal.fire({
                    title: 'Success!',
                    text: res.message,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                }).then(()=> location.reload());
            }
        });
    });

    // Delete circular
    document.querySelectorAll('.deleteBtn').forEach(btn=>{
        btn.addEventListener('click', function(){
            const id = this.dataset.id;
            Swal.fire({
                title: 'Are you sure?',
                text: "This will delete the circular!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result)=>{
                if(result.isConfirmed){
                    $.post('/admin/circular/delete', {id:id}, function(res){
                        Swal.fire({
                            title: 'Deleted!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#28a745'
                        }).then(()=> $('#row-'+id).remove());
                    });
                }
            });
        });
    });

    // Delete single file
    document.addEventListener('click', function(e){
        if(e.target.classList.contains('deleteFileBtn')){
            const id = e.target.dataset.id;
            const file = e.target.dataset.file;
            Swal.fire({
                title: 'Are you sure?',
                text: "This will delete the file!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result)=>{
                if(result.isConfirmed){
                    $.post('/admin/circular/delete-file', {id:id, file:file}, function(res){
                        Swal.fire({
                            title: 'Deleted!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#28a745'
                        }).then(()=> e.target.closest('div').remove());
                    });
                }
            });
        }
    });

});

$(document).ready(function() {
    $('#circularTable').DataTable({
        "paging": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "lengthChange": true,
        "pageLength": 10,
        "columnDefs": [
            { "orderable": false, "targets": 6 },
            { "orderable": false, "targets": 7 }
        ]
    });
});
</script>

{% endblock %}
