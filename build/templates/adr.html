{% extends "base.html" %}
{% block content %}
    <div class="container">
        <div id="search-items" class="row mt-3 align-items-end mb-3">

            <!-- Section Dropdown -->
            <div class="col-md-2" id="section">
                <label for="sectionSelect" class="form-label">Select Section:</label>
                <select id="sectionSelect" name="section" class="form-control">
                    <option value="">-- Select Section --</option>
                    {% for sec in sections %}
                        <option value="{{ sec|e }}">{{ sec|e }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Year Dropdown -->
            <div class="col-md-2" id="financial-year-block">
                <label for="yearSelect" class="form-label">Financial Year:</label>
                <select id="yearSelect" name="year" class="form-control">
                    <option value="">-- Select --</option>
                </select>
            </div>

            <!-- Title Dropdown -->
            <div class="col-md-4" id="search-block">
                <label for="titleSelect" class="form-label">Select Heading:</label>
                <select id="titleSelect" name="titleSelect" class="form-control">
                    <option value="">-- Select --</option>
                </select>
            </div>

            <!-- Search Content -->
            <div class="col-md-3" id="search-content-block">
                <label for="search-content">Search Content:</label>
                <input type="text" id="search-content" class="form-control" placeholder="Type to search..."/>
            </div>

            <!-- Search Button -->
            <div class="col-md-1 mt-2">
                <button id="searchBtn" class="btn btn-success">Search</button>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="container">
        <div class="row mt-3">
            <div class="col-md-12">
                <div id="search-results"></div>
                <div id="related-results"></div>
            </div>
        </div>
    </div>
    <style>
        .highlighted {
            background-color: yellow;
        }
    </style>
{% endblock %}
{% block scripts %}
<script>
        $(document).ready(function () {
            const cat = "ADR";  // fixed category
            const BASE_URL = "{{ url_for('static', filename='uploads/') }}";

            console.log("Category:", cat);

            $('#uploadsTable').DataTable({
                ajax: {
                    url: "{{ url_for('upload_search.api_upload_files') }}",
                    data: {cat: cat},
                    dataSrc: function (json) {
                        console.log("API response:", json);
                        return json.data || [];
                    }
                },
                columns: [
                    {data: 'category'},
                    {data: 'number'},
                    // â­ FORMATTED DATE COLUMN (dd-mm-yyyy)
                    {
                        data: 'date',
                        render: function (data) {
                            if (!data) return "";

                            const d = new Date(data);
                            if (isNaN(d)) return data; // return original if invalid date

                            let day = String(d.getDate()).padStart(2, '0');
                            let month = String(d.getMonth() + 1).padStart(2, '0');
                            let year = d.getFullYear();

                            return `${day}-${month}-${year}`;
                        }
                    },
                    {data: 'year'},
                    {data: 'subject'},
                    {
                        data: 'files',
                        render: function (files) {
                            if (!files || !files.length) return '';
                            return files.map(f =>
                                `<a href="${BASE_URL}${encodeURIComponent(f)}" target="_blank"><i class="fas fa-eye"></i></a>`
                            ).join('<br>');
                        }
                    }
                ]
            });
        });
    </script>

{% endblock %}
